# ğŸ—ï¸ é¡¹ç›®æ¶æ„è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ PGC ç”Ÿç‰©å®éªŒå®¤çš„æ¨¡å—åŒ–æ¶æ„è®¾è®¡ã€‚

## ğŸ“ æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·ç•Œé¢ (UI)                       â”‚
â”‚                     index.html + CSS                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¸»æ§åˆ¶å™¨ (main.js)                     â”‚
â”‚  - åœºæ™¯åˆå§‹åŒ–                                            â”‚
â”‚  - UI äº‹ä»¶ç»‘å®š                                           â”‚
â”‚  - åŠ¨ç”»å¾ªç¯                                              â”‚
â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚          â”‚          â”‚          â”‚          â”‚
   â–¼          â–¼          â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ Core â”‚  â”‚Logic â”‚  â”‚Graph â”‚  â”‚Anim  â”‚  â”‚Configâ”‚
â”‚ æ ¸å¿ƒ â”‚  â”‚ é€»è¾‘ â”‚  â”‚ å›¾å½¢ â”‚  â”‚ åŠ¨ç”» â”‚  â”‚ é…ç½® â”‚
â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ æ¨¡å—åˆ’åˆ†

### 1. æ ¸å¿ƒæ¨¡å— (core/)

#### math.js - æ•°å­¦å·¥å…·åº“
**èŒè´£**: æä¾›çº¯æ•°å­¦ç®—æ³•ï¼Œä¸ä¾èµ–ä»»ä½•å¤–éƒ¨åº“

**å¯¼å‡º**:
- `PseudoRandom`: ä¼ªéšæœºæ•°ç”Ÿæˆå™¨
  - `random()`: ç”Ÿæˆ [0, 1) éšæœºæ•°
  - `range(min, max)`: ç”ŸæˆèŒƒå›´å†…éšæœºæ•°
  - `choose(arr)`: ä»æ•°ç»„éšæœºé€‰æ‹©

- `FastSDF`: æœ‰å‘è·ç¦»åœºç®—æ³•
  - `taperedSegment()`: é”¥å½¢çº¿æ®µ SDF
  - `smin()`: å¹³æ»‘æœ€å°å€¼ï¼ˆèåˆï¼‰
  - `noise()`: 3D å™ªå£°å‡½æ•°

**ä¾èµ–**: æ— 

#### utils.js - é€šç”¨å·¥å…·
**èŒè´£**: æä¾›æ—¥å¿—ã€é¢œè‰²è®¡ç®—ç­‰å·¥å…·å‡½æ•°

**å¯¼å‡º**:
- `log(msg)`: æ§åˆ¶å°å’Œ UI æ—¥å¿—
- `getVertexColor(health)`: æ ¹æ®å¥åº·å€¼è®¡ç®—é¢œè‰²

**ä¾èµ–**: æ— 

---

### 2. é€»è¾‘æ¨¡å— (logic/)

#### dna.js - DNA ç³»ç»Ÿ
**èŒè´£**: åŸºå› åˆ°è¡¨å‹çš„æ˜ å°„

**å¯¼å‡º**:
- `resolveDNA(params, activeTraits)`: è§£æ DNA
- `getMaterialMapping(skinType)`: è·å–æè´¨æ˜ å°„
- `applyTraitModifiers(params, activeTraits)`: åº”ç”¨ç‰¹æ€§ä¿®é¥°ç¬¦

**ä¾èµ–**:
- `core/math.js` (PseudoRandom)
- `config.js` (TRAIT_DEFINITIONS)

**æ•°æ®æµ**:
```
ç§å­ + ç‰¹æ€§ â†’ DNA å¯¹è±¡ â†’ ä¿®é¥°ç¬¦ â†’ éª¨éª¼å‚æ•°
```

#### skeleton.js - éª¨éª¼ç”Ÿæˆ
**èŒè´£**: ç”Ÿæˆç”Ÿç‰©çš„éª¨éª¼ç»“æ„

**å¯¼å‡º**:
- `SkeletonNode`: éª¨éª¼èŠ‚ç‚¹ç±»
- `generateSkeleton(params, activeTraits)`: ç”Ÿæˆéª¨éª¼
- `createBones(nodes)`: åˆ›å»º Three.js éª¨éª¼
- `applyDamage(fullNodes, healthPercentage)`: åº”ç”¨ä¼¤å®³

**ä¾èµ–**:
- `three` (THREE.Vector3, THREE.Bone)
- `core/math.js` (PseudoRandom)
- `logic/dna.js` (resolveDNA, getMaterialMapping)
- `core/utils.js` (log)

**æ•°æ®æµ**:
```
å‚æ•° + ç‰¹æ€§ â†’ DNA â†’ éª¨éª¼èŠ‚ç‚¹æ•°ç»„ â†’ Three.js Bones
```

#### mesher.js - ç½‘æ ¼ç”Ÿæˆ
**èŒè´£**: ä½“ç´ åŒ–å’Œç½‘æ ¼ç”Ÿæˆï¼ˆæœ€å¤æ‚çš„æ¨¡å—ï¼‰

**å¯¼å‡º**:
- `generateOptimizedMesh(nodes, params, health, currentDNA, matGenes, textureFactory)`: ç”Ÿæˆä¼˜åŒ–ç½‘æ ¼

**ä¾èµ–**:
- `three` (THREE.BufferGeometry)
- `core/math.js` (FastSDF)
- `core/utils.js` (log, getVertexColor)

**ç®—æ³•æµç¨‹**:
```
1. è®¡ç®—åŒ…å›´ç›’
2. ä½“ç´ åŒ–ç©ºé—´åˆ’åˆ†
3. SDF è·ç¦»åœºè®¡ç®—
4. å¹³æ»‘èåˆï¼ˆsminï¼‰
5. è¡¨é¢æå–ï¼ˆMarching Cubes å˜ä½“ï¼‰
6. æè´¨åˆ†ç»„
7. ç”Ÿæˆ BufferGeometry
```

**æ€§èƒ½å…³é”®ç‚¹**:
- ä½¿ç”¨ Float32Array ç¼“å­˜éª¨éª¼æ•°æ®
- é¢„è®¡ç®—å¹³æ»‘ç³»æ•°
- æŒ‰æè´¨åˆ†æ¡¶å‡å°‘ draw call

---

### 3. å›¾å½¢æ¨¡å— (graphics/)

#### materials.js - æè´¨å·¥å‚
**èŒè´£**: ç¨‹åºç”Ÿæˆçº¹ç†å’Œæè´¨

**å¯¼å‡º**:
- `TextureFactory`: æè´¨å·¥å‚ç±»
  - `createNoiseCanvas()`: åˆ›å»ºç¨‹åºçº¹ç†
  - `createNormalMap()`: ç”Ÿæˆæ³•çº¿è´´å›¾
  - `initMaterials()`: åˆå§‹åŒ–æè´¨åº“
  - `materials`: æè´¨æ•°ç»„

**ä¾èµ–**:
- `three` (THREE.CanvasTexture, THREE.MeshPhongMaterial)

**çº¹ç†ç±»å‹**:
- noise: éšæœºå™ªå£°
- scales: é³ç‰‡çº¹ç†
- striated: æ¡çº¹çº¹ç†
- keratin: è§’è´¨çº¹ç†
- feathers: ç¾½æ¯›çº¹ç†
- fur: æ¯›çš®çº¹ç†
- chitin: ç”²å£³çº¹ç†
- crystal: æ™¶ä½“çº¹ç†

#### effects.js - ç‰¹æ•ˆç³»ç»Ÿ
**èŒè´£**: ç²’å­ç‰¹æ•ˆå’Œè§†è§‰æ•ˆæœ

**å¯¼å‡º**:
- `SkillEffectSystem`: ç‰¹æ•ˆç³»ç»Ÿç±»
  - `spawn(origin)`: ç”Ÿæˆç²’å­
  - `update(dt)`: æ›´æ–°ç²’å­

**ä¾èµ–**:
- `three` (THREE.Mesh, THREE.TetrahedronGeometry)

#### baker.js - ç²¾çµçƒ˜ç„™
**èŒè´£**: å°† 3D åŠ¨ç”»å¯¼å‡ºä¸º 2D ç²¾çµåºåˆ—

**å¯¼å‡º**:
- `SpriteBaker`: çƒ˜ç„™å™¨ç±»
  - `bake(animationName, frameCount, size, angle)`: çƒ˜ç„™åŠ¨ç”»

**ä¾èµ–**:
- `three` (THREE.OrthographicCamera, THREE.WebGLRenderer)

**å·¥ä½œæµç¨‹**:
```
1. åˆ›å»ºæ­£äº¤ç›¸æœº
2. åˆ›å»ºç¦»å±æ¸²æŸ“å™¨
3. é€å¸§æ¸²æŸ“åŠ¨ç”»
4. æ‹¼æ¥ä¸ºç²¾çµè¡¨
5. å¯¼å‡º PNG
```

---

### 4. åŠ¨ç”»æ¨¡å— (animation/)

#### controller.js - åŠ¨ç”»æ§åˆ¶å™¨
**èŒè´£**: éª¨éª¼åŠ¨ç”»çŠ¶æ€ç®¡ç†

**å¯¼å‡º**:
- `AnimationController`: åŠ¨ç”»æ§åˆ¶å™¨ç±»
  - `updateDNA(seed)`: æ›´æ–° DNA å‚æ•°
  - `setAnimation(name)`: è®¾ç½®åŠ¨ç”»çŠ¶æ€
  - `triggerHit()`: è§¦å‘å—å‡»
  - `update(skeleton, dt, nodes, mesh)`: æ›´æ–°åŠ¨ç”»

**ä¾èµ–**:
- `three` (THREE.Vector3)

**åŠ¨ç”»çŠ¶æ€**:
- `idle`: å¾…æœºï¼ˆå‘¼å¸åŠ¨ç”»ï¼‰
- `walk`: è¡Œèµ°ï¼ˆå¾ªç¯åŠ¨ç”»ï¼‰
- `hit`: å—å‡»ï¼ˆéœ‡åŠ¨æ•ˆæœï¼‰
- `skill`: æŠ€èƒ½ï¼ˆç‰¹æ•ˆåŠ¨ç”»ï¼‰

**åŠ¨ç”»ç³»ç»Ÿ**:
```
çŠ¶æ€æœº â†’ éª¨éª¼æ—‹è½¬ â†’ æè´¨å‘å…‰ â†’ æ¸²æŸ“
```

---

### 5. é…ç½®æ¨¡å—

#### config.js - é…ç½®æ•°æ®
**èŒè´£**: é›†ä¸­ç®¡ç†æ‰€æœ‰é…ç½®

**å¯¼å‡º**:
- `TRAIT_DEFINITIONS`: ç‰¹æ€§å®šä¹‰
- `DEFAULT_PARAMS`: é»˜è®¤å‚æ•°

**ç‰¹æ€§ç»“æ„**:
```javascript
{
  icon: 'ğŸ›¡ï¸',
  name: 'è­·ç›¾',
  desc: 'é‡‘å±¬/æ™¶é«”å¤–æ®¼',
  modifiers: { scale: 1.3, muscle: 1.5, limbLen: 0.9 },
  forcedSkin: 'chitin',
  tint: [0.6, 0.7, 1.0],
  feature: 'crystal_shoulders'
}
```

---

## ğŸ”„ æ•°æ®æµå›¾

```
ç”¨æˆ·è¾“å…¥ (UI)
    â†“
é…ç½®å‚æ•° (seed, traits, health)
    â†“
DNA è§£æ (dna.js)
    â†“
éª¨éª¼ç”Ÿæˆ (skeleton.js)
    â†“
ä¼¤å®³åº”ç”¨ (skeleton.js)
    â†“
ç½‘æ ¼ç”Ÿæˆ (mesher.js)
    â†“
æè´¨åº”ç”¨ (materials.js)
    â†“
éª¨éª¼ç»‘å®š (Three.js)
    â†“
åŠ¨ç”»æ›´æ–° (controller.js)
    â†“
ç‰¹æ•ˆæ¸²æŸ“ (effects.js)
    â†“
åœºæ™¯æ¸²æŸ“ (Three.js)
```

## ğŸ¯ è®¾è®¡åŸåˆ™

### 1. å•ä¸€èŒè´£
æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„åŠŸèƒ½é¢†åŸŸã€‚

### 2. ä¾èµ–å€’ç½®
é«˜å±‚æ¨¡å—ï¼ˆmain.jsï¼‰ä¾èµ–æŠ½è±¡æ¥å£ï¼Œä¸ä¾èµ–å…·ä½“å®ç°ã€‚

### 3. å¼€é—­åŸåˆ™
å¯¹æ‰©å±•å¼€æ”¾ï¼ˆæ·»åŠ æ–°ç‰¹æ€§ï¼‰ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼ˆä¸æ”¹åŠ¨æ ¸å¿ƒä»£ç ï¼‰ã€‚

### 4. æ¥å£éš”ç¦»
æ¨¡å—é—´é€šè¿‡æ¸…æ™°çš„å‡½æ•°æ¥å£é€šä¿¡ï¼Œé¿å…ç›´æ¥è®¿é—®å†…éƒ¨çŠ¶æ€ã€‚

### 5. ä¾èµ–æ³¨å…¥
å°† TextureFactory ç­‰ä¾èµ–ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œä¾¿äºæµ‹è¯•å’Œæ›¿æ¢ã€‚

## ğŸš€ æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°ç‰¹æ€§
1. åœ¨ `config.js` æ·»åŠ å®šä¹‰
2. åœ¨ `dna.js` æ·»åŠ ä¿®é¥°ç¬¦é€»è¾‘ï¼ˆå¦‚éœ€è¦ï¼‰
3. åœ¨ `skeleton.js` åº”ç”¨ä¿®é¥°ç¬¦ï¼ˆå¦‚éœ€è¦ï¼‰

### æ·»åŠ æ–°çº¹ç†
1. åœ¨ `materials.js` çš„ `createNoiseCanvas()` æ·»åŠ æ–°ç±»å‹
2. åœ¨ `initMaterials()` ä¸­æ³¨å†Œ

### æ·»åŠ æ–°åŠ¨ç”»
1. åœ¨ `controller.js` çš„ `update()` æ·»åŠ æ–°çŠ¶æ€
2. åœ¨ UI æ·»åŠ è§¦å‘æŒ‰é’®

### ä¼˜åŒ–æ€§èƒ½
1. **Web Worker**: å°† `mesher.js` ç§»è‡³ Worker
2. **LOD**: æ ¹æ®è·ç¦»è°ƒæ•´åˆ†è¾¨ç‡
3. **å®ä¾‹åŒ–**: å¯¹ç›¸åŒç”Ÿç‰©ä½¿ç”¨ InstancedMesh

## ğŸ”§ è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹éª¨éª¼ç»“æ„
```javascript
console.log(fullNodesBlueprint);
```

### æŸ¥çœ‹ä½“ç´ æ•°æ®
åœ¨ `mesher.js` ä¸­æ·»åŠ ï¼š
```javascript
console.log(`Active voxels: ${activeVoxels}`);
```

### æŸ¥çœ‹æè´¨åˆ†ç»„
åœ¨ `mesher.js` ä¸­æ·»åŠ ï¼š
```javascript
console.log(`Bucket ${m}: ${count} faces`);
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

- **éª¨éª¼ç”Ÿæˆ**: < 5ms
- **ä½“ç´ åŒ–**: 50-200msï¼ˆå–å†³äºåˆ†è¾¨ç‡ï¼‰
- **ç½‘æ ¼ç”Ÿæˆ**: 20-100ms
- **åŠ¨ç”»æ›´æ–°**: < 1ms/frame
- **æ¸²æŸ“**: 60 FPS @ 1080p

## ğŸ“ æŠ€æœ¯æ ˆ

- **Three.js 0.128.0**: 3D æ¸²æŸ“å¼•æ“
- **ES6 Modules**: æ¨¡å—ç³»ç»Ÿ
- **Canvas API**: çº¹ç†ç”Ÿæˆ
- **WebGL**: GPU åŠ é€Ÿæ¸²æŸ“

---

**ç»´æŠ¤è€…**: PGC Team  
**æœ€åæ›´æ–°**: 2024-01-03
